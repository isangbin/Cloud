{% extends 'base.html' %}
{% block style %}
  body{
    margin-top:3rem;
    
  }
  @media (min-width: 0) {
    .g-mr-15 {
        margin-right: 1.07143rem !important;
    }
  }
  @media (min-width: 0){
    .g-mt-3 {
        margin-top: 0.21429rem !important;
    }
  }

  .g-height-50 {
    height: 50px;
  }

  .g-width-50 {
    width: 50px !important;
  }

  @media (min-width: 0){
    .g-pa-30 {
        padding: 2.14286rem !important;
    }
  }

  .g-bg-secondary {
    {% comment %} background-color: #fafafa !important; {% endcomment %}
    border-style: solid;
    border-color: white;
  }

  .u-shadow-v18 {
    box-shadow: 0 5px 10px -6px rgba(0, 0, 0, 0.15);
  }

  .g-color-gray-dark-v4 {
    color: #777 !important;
  }

  .g-font-size-12 {
    font-size: 0.85714rem !important;
  }

  .media-comment {
    margin-top:20px
  }
{% endblock style %}

{% block content %}
  <h1>Community</h1>
  <a href="{% url 'community:create' %}">New review</a>
  <hr>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <div class="container">
      <div class="row">
        {% for review in reviews %}
          <div class="col-md-10">
            <div class="media g-mb-30 media-comment">
              {% comment %} <img class="d-flex g-width-50 g-height-50 rounded-circle g-mt-3 g-mr-15" src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Image Description"> {% endcomment %}
              <div class="media-body u-shadow-v18 g-bg-secondary g-pa-30">
                <div class="g-mb-15">
                  <h5 class="h5 g-color-gray-dark-v1 mb-0">{{ review.user }}</h5>
                  <span class="g-color-gray-dark-v4 g-font-size-12">{{ review.created_at }}</span>
                </div>
                
                <p>{{ review.content }}</p>
                  
                <ul class="list-inline d-sm-flex my-0">
                  <li class="list-inline-item g-mr-20">
                    <a class="u-link-v5 g-color-gray-dark-v4 g-color-primary--hover" href="#!">
                      <form class="like-forms" data-review-id="{{ review.pk }}">
                        {% csrf_token %}
                        {% if user in review.like_users.all %}
                          <button><i id="like-{{ review.pk }}" class="fa-solid fa-thumbs-up g-pos-rel g-top-1 g-mr-3"></button>
                        {% else %}
                          <button><i id="like-{{ review.pk }}" class="fa-regular fa-thumbs-up g-pos-rel g-top-1 g-mr-3"></i></button>
                        {% endif %}
                      </form>
                    </a>
                  </li>
                  <li class="list-inline-item g-mr-20">
                    <p><span id="likes-count-{{ review.pk }}">{{ review.like_users.all|length }}</span></p>
                  </li>
                  <li class="list-inline-item ml-auto">
                    <a class="u-link-v5 g-color-gray-dark-v4 g-color-primary--hover" href="{% url 'community:detail' review.pk %}">
                      <i class="fa fa-reply g-pos-rel g-top-1 g-mr-3"></i>
                      Detail
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% comment %} {% for review in reviews %}
    <p>작성자 : <a href="{% url 'accounts:profile' review.user.username %}">{{ review.user }}</a></p>
    <p>글 번호: {{ review.pk }}</p>
    <p>글 제목: {{ review.title }}</p>
    <p>글 내용: {{ review.content }}</p>
    <form class="like-forms" data-review-id="{{ review.pk }}">
      {% csrf_token %}
      {% if user in review.like_users.all %}
        <button id="like-{{ review.pk }}">좋아요 취소</button>
      {% else %}
        <button id="like-{{ review.pk }}">좋아요</button>
      {% endif %}
      <p>
        <span id="likes-count-{{ review.pk }}">{{ review.like_users.all|length }}</span> 명이 이 글을 좋아합니다.
      </p>
    </form>
    <a href="{% url 'community:detail' review.pk %}">[detail]</a>
    <hr>
  {% endfor %} {% endcomment %}
{% endblock %}

{% block script %}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const forms = document.querySelectorAll('.like-forms')
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

    forms.forEach((form) => {
      form.addEventListener('submit', function (event) {
        event.preventDefault()
        const reviewId = event.target.dataset.reviewId

        axios({
          method: 'post',
          url: `http://127.0.0.1:8000/community/${reviewId}/like/`,
          headers: {'X-CSRFToken': csrftoken},
        })
        .then((response) => {
          const isLiked = response.data.is_liked
          const likeiTag = document.querySelector(`#like-${reviewId}`)

          if (isLiked === true) {
            likeiTag.setAttribute('class', 'fa-solid fa-thumbs-up g-pos-rel g-top-1 g-mr-3')
          } else {
            likeiTag.setAttribute('class', 'fa-regular fa-thumbs-up g-pos-rel g-top-1 g-mr-3')
          }

          const likesCountTag = document.querySelector(`#likes-count-${reviewId}`)
          const likesCount = response.data.likes_count
          likesCountTag.innerText = likesCount
        })
        .catch((error) => {
          console.log(error.response)
        })
      })
    })
  </script>
{% endblock script %}
